<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Kampforslag</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple transition for showing the slots */
        #slots-container.hidden, #participant-container.hidden {
            opacity: 0;
            transform: translateY(-10px);
            max-height: 0;
            overflow: hidden;
        }
        #slots-container, #participant-container {
            opacity: 1;
            transform: translateY(0);
            max-height: 2000px; /* Arbitrary large number */
            transition: all 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto space-y-8">
        <main id="proposal-view" class="bg-gray-800 p-8 rounded-2xl shadow-2xl text-center">
            <h1 id="main-title" class="text-3xl font-bold text-emerald-400 mb-2">Padel Kamp Planlægger</h1>
            <p id="sub-title" class="text-gray-400 mb-6">Indlæser dine kampdata...</p>
            
            <div id="opponent-selector-container" class="mb-6 hidden">
                <label for="opponent-select" class="block text-left font-medium mb-2 text-gray-300">1. Vælg modstander at planlægge med</label>
                <select id="opponent-select" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600 focus:border-emerald-500 focus:outline-none">
                    <option value="">-- Vælg et hold --</option>
                </select>
            </div>

            <div id="slots-container" class="space-y-4 hidden">
                <!-- Time slots will be dynamically inserted here -->
            </div>
        </main>

        <!-- Participant List -->
        <section id="participant-container" class="bg-gray-800 p-8 rounded-2xl shadow-2xl hidden">
            <h2 class="text-2xl font-bold text-emerald-400 mb-4 text-center">Deltagere i Ligaen</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="border-b-2 border-gray-700">
                        <tr>
                            <th class="p-3 text-gray-300">Navn</th>
                            <th class="p-3 text-gray-300">Telefon</th>
                        </tr>
                    </thead>
                    <tbody id="participant-table-body">
                        <!-- Participant rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- KONFIGURATION ---
    const API_URL = "https://api.appwork.dk/Leagues/pools/matches-not-played?includeDuplicateMatches=true";
    const API_TOKEN = "79br26mwLvOcsLrfNiGQ"; // Dit personlige authorization token
    const MIT_TELEFONNUMMER = "+4521125950";
    const KAMP_VARIGHED_TIMER = 2;
    const TIDSBLOK_MINUTTER = 30;
    // Definer din generelle tilgængelighed her
    const FORESLÅEDE_TIDSRUM = [
        { date: "2025-08-25", startTime: "08:00", endTime: "14:00" },
        { date: "2025-08-26", startTime: "16:00", endTime: "22:00" },
        { date: "2025-08-27", startTime: "09:00", endTime: "21:00" }
    ];

    // --- DOM ELEMENTER ---
    const mainTitle = document.getElementById('main-title');
    const subTitle = document.getElementById('sub-title');
    const opponentSelectorContainer = document.getElementById('opponent-selector-container');
    const opponentSelect = document.getElementById('opponent-select');
    const slotsContainer = document.getElementById('slots-container');
    const participantContainer = document.getElementById('participant-container');
    const participantTableBody = document.getElementById('participant-table-body');


    let leagueData = {};

    // --- HJÆLPEFUNKTIONER ---
    const formatTime = (date) => date.toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit', hour12: false });
    const formatDateHeading = (dateString) => {
        const date = new Date(dateString + "T00:00:00");
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        return date.toLocaleDateString('da-DK', options);
    };
    const formatSlotForSMS = (start, end) => {
        const options = { weekday: 'short', month: 'short', day: 'numeric' };
        const datePart = start.toLocaleDateString('da-DK', options);
        return `${datePart} kl. ${formatTime(start)}-${formatTime(end)}`;
    };

    // --- KERNE LOGIK ---

    // Viser listen over alle deltagere
    const renderParticipantList = (allPlayers) => {
        participantTableBody.innerHTML = '';
        const sortedPlayers = Array.from(allPlayers.values()).sort((a, b) => a.firstName.localeCompare(b.firstName));

        sortedPlayers.forEach(player => {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-700';
            
            const nameCell = document.createElement('td');
            nameCell.className = 'p-3';
            nameCell.textContent = `${player.firstName} ${player.lastName}`;

            const phoneCell = document.createElement('td');
            phoneCell.className = 'p-3';
            const phoneLink = document.createElement('a');
            phoneLink.href = `tel:+${player.phoneCountryCode}${player.phone}`;
            phoneLink.className = 'text-emerald-400 hover:underline';
            phoneLink.textContent = `+${player.phoneCountryCode} ${player.phone}`;
            
            phoneCell.appendChild(phoneLink);
            row.appendChild(nameCell);
            row.appendChild(phoneCell);
            participantTableBody.appendChild(row);
        });
        participantContainer.classList.remove('hidden');
    };

    // Genererer og viser knapper med tidspunkter for den valgte modstander
    const generateTimeSlots = (selectedOpponentId) => {
        slotsContainer.innerHTML = ''; // Ryd tidligere tidspunkter
        if (!selectedOpponentId) {
            slotsContainer.classList.add('hidden');
            return;
        }

        const mitHoldnavn = `${leagueData.ownTeam.player1.firstName} & ${leagueData.ownTeam.player2.firstName}`;
        const modstander = leagueData.opponents.get(selectedOpponentId);
        
        let hasSlots = false;

        FORESLÅEDE_TIDSRUM.forEach(span => {
            const dayContainer = document.createElement('div');
            const heading = document.createElement('h2');
            heading.className = "text-xl font-semibold text-left text-emerald-300 border-b-2 border-gray-700 pb-2 mb-3";
            heading.textContent = formatDateHeading(span.date);
            dayContainer.appendChild(heading);

            const grid = document.createElement('div');
            grid.className = "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2";

            const matchDurationMillis = KAMP_VARIGHED_TIMER * 60 * 60 * 1000;
            const incrementMillis = TIDSBLOK_MINUTTER * 60 * 1000;
            const startDateTime = new Date(`${span.date}T${span.startTime}`);
            const endDateTime = new Date(`${span.date}T${span.endTime}`);

            let currentStartTime = startDateTime.getTime();

            while (currentStartTime + matchDurationMillis <= endDateTime.getTime()) {
                hasSlots = true;
                const slotStart = new Date(currentStartTime);
                const slotEnd = new Date(currentStartTime + matchDurationMillis);

                const button = document.createElement('button');
                button.className = 'w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-2 rounded-lg transition-colors text-sm';
                button.textContent = `${formatTime(slotStart)} - ${formatTime(slotEnd)}`;
                
                button.onclick = () => {
                    const message = `Hej ${mitHoldnavn}, her er ${modstander.name}. Vi bekræfter vores kamp den ${formatSlotForSMS(slotStart, slotEnd)}. Vi ses på banen!`;
                    window.location.href = `sms:${MIT_TELEFONNUMMER}?body=${encodeURIComponent(message)}`;
                };
                
                grid.appendChild(button);
                currentStartTime += incrementMillis;
            }

            if (grid.hasChildNodes()) {
                dayContainer.appendChild(grid);
                slotsContainer.appendChild(dayContainer);
            }
        });
        
        slotsContainer.classList.remove('hidden');

        if (!hasSlots) {
            slotsContainer.innerHTML = '<p class="text-gray-400">Ingen ledige tider i de angivne tidsrum.</p>';
        }
    };

    // Henter data og initialiserer applikationen
    const initializeScheduler = async () => {
        try {
            const response = await fetch(API_URL, {
                headers: {
                    'Authorization': `Bearer ${API_TOKEN}`
                }
            });
            if (!response.ok) throw new Error(`HTTP fejl! status: ${response.status}`);
            const data = await response.json();
            
            leagueData = data[0];
            const mitHoldnavn = `${leagueData.ownTeam.player1.firstName} & ${leagueData.ownTeam.player2.firstName}`;
            mainTitle.textContent = `Planlægning for ${mitHoldnavn}`;

            // Saml alle unikke spillere og modstanderhold
            const allPlayers = new Map();
            const addPlayer = (player) => {
                if (player && player.id && !allPlayers.has(player.id)) {
                    allPlayers.set(player.id, player);
                }
            };
            
            addPlayer(leagueData.ownTeam.player1);
            addPlayer(leagueData.ownTeam.player2);

            leagueData.opponents = new Map();
            leagueData.matchInfo.forEach(match => {
                const opponent = match.opponentTeam;
                addPlayer(opponent.player1);
                addPlayer(opponent.player2);
                
                const opponentId = opponent.id;
                if (!leagueData.opponents.has(opponentId)) {
                    leagueData.opponents.set(opponentId, {
                        id: opponentId,
                        name: `${opponent.player1.firstName} & ${opponent.player2.firstName}`
                    });
                }
            });

            // Vis deltagerlisten
            renderParticipantList(allPlayers);

            // Udfyld dropdown med modstandere
            leagueData.opponents.forEach(opponent => {
                const option = document.createElement('option');
                option.value = opponent.id;
                option.textContent = opponent.name;
                opponentSelect.appendChild(option);
            });

            subTitle.textContent = "Vælg et hold fra menuen for at se ledige spilletider.";
            opponentSelectorContainer.classList.remove('hidden');

        } catch (error) {
            console.error("Kunne ikke hente ligadata:", error);
            subTitle.textContent = "Fejl: Kunne ikke indlæse kampdata. Prøv venligst igen senere.";
            subTitle.classList.add('text-red-400');
        }
    };

    // --- EVENT LISTENERS ---
    opponentSelect.addEventListener('change', (e) => {
        generateTimeSlots(e.target.value);
    });

    // --- START ---
    initializeScheduler();
});
</script>

</body>
</html>

